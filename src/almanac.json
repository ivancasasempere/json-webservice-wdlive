<?php header('content-type: application/json; charset=utf-8');

# Copyright 2015 Wayne D Grant (www.waynedgrant.com)
# Licensed under the MIT License

require_once("config.php");
require_once("common.php");
require_once("ClientRaw.php");
require_once("ClientRawExtra.php");

function createAlmanacMeasurement($measurement, $measurementTime)
{
    $almanacMeasurement = $measurement->getAllMeasures();
    $almanacMeasurement['time'] = $measurementTime->getAllValues();
    return $almanacMeasurement;
}

function createWindAlmanacMeasurement($speedMeasurement, $directionMeasurement, $measurementTime)
{
    return array(
        "speed" => $speedMeasurement->getAllMeasures(),
        "direction" => $directionMeasurement->getAllMeasures(),
        "time" => $measurementTime->getAllValues());
}

function createMonthToDate($clientRawExtra, $dateAndTime)
{
    $highOutdoorTemperature = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyHighOutdoorTemperature(), $clientRawExtra->getMonthlyHighOutdoorTemperatureDateAndTime());

    $lowOutdoorTemperature = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyLowOutdoorTemperature(), $clientRawExtra->getMonthlyLowOutdoorTemperatureDateAndTime());

    $highPressure = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyHighSurfacePressure(), $clientRawExtra->getMonthlyHighSurfacePressureDateAndTime());

    $lowPressure = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyLowSurfacePressure(), $clientRawExtra->getMonthlyLowSurfacePressureDateAndTime());

    $maximumRainfallRate = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyMaximumRainfallRate(), $clientRawExtra->getMonthlyMaximumRainfallRateDateAndTime());

    $maximumAverageWindSpeed = createWindAlmanacMeasurement(
        $clientRawExtra->getMonthlyMaximumAverageWindSpeed(), $clientRawExtra->getMonthlyMaximumAverageWindSpeedDirection(),
        $clientRawExtra->getMonthlyMaximumAverageWindSpeedDateAndTime());

    $maximumGustSpeed = createWindAlmanacMeasurement(
        $clientRawExtra->getMonthlyMaximumGustSpeed(), $clientRawExtra->getMonthlyMaximumGustSpeedDirection(),
        $clientRawExtra->getMonthlyMaximumGustSpeedDateAndTime());

    $highDewPoint = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyHighDewPoint(), $clientRawExtra->getMonthlyHighDewPointDateAndTime());

    $lowDewPoint = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyLowDewPoint(), $clientRawExtra->getMonthlyLowDewPointDateAndTime());

    $lowWindChill = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyLowWindChill(), $clientRawExtra->getMonthlyLowWindChillDateAndTime());

    $highHeatIndex = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyHighHeatIndex(), $clientRawExtra->getMonthlyHighHeatIndexDateAndTime());

    $highUv = createAlmanacMeasurement(
        $clientRawExtra->getMonthlyHighUv(), $clientRawExtra->getMonthlyHighUvDateAndTime());

    return array(
        "month" => $dateAndTime->getMonth(),
        "year" => $dateAndTime->getYear(),
        "temperature" => array("high" => $highOutdoorTemperature, "low" => $lowOutdoorTemperature),
        "pressure" => array("high" => $highPressure, "low" => $lowPressure),
        "rainfall" => array("max_rate_per_min" => $maximumRainfallRate),
        "wind" => array("max_avg" => $maximumAverageWindSpeed, "max_gust" => $maximumGustSpeed),
        "dew_point" => array("high" => $highDewPoint, "low" => $lowDewPoint),
        "wind_chill" => array("low" => $lowWindChill),
        "heat_index" => array("high" => $highHeatIndex),
        "uv" => array("high" => $highUv));
}

function createYearToDate($clientRawExtra, $dateAndTime)
{
    return array(
        "year" => $dateAndTime->getYear(),
        "temperature" => array(),
        "pressure" => array(),
        "rainfall" => array(),
        "wind" => array(),
        "dew_point" => array(),
        "wind_chill" => array(),
        "heat_index" => array(),
        "uv" => array());
}

function createAllTime($clientRawExtra)
{
    return array(
        "temperature" => array(),
        "pressure" => array(),
        "rainfall" => array(),
        "wind" => array(),
        "dew_point" => array(),
        "wind_chill" => array(),
        "heat_index" => array(),
        "uv" => array());
}

$clientRaw = new ClientRaw(CLIENT_RAW_DIRECTORY . "clientraw.txt");
$clientRawExtra = new ClientRawExtra(CLIENT_RAW_DIRECTORY . "clientrawextra.txt");

$dateAndTime = $clientRaw->getCurrentDateAndTime();

$data = array(
    "endpoint" => createEndpoint(),
    "station" => createStation($clientRaw),
    "time" => $dateAndTime->getAllValues(),
    "month_to_date" => createMonthToDate($clientRawExtra, $dateAndTime),
    "year_to_date" => createYearToDate($clientRawExtra, $dateAndTime),
    "all_time" => createAllTime($clientRawExtra));

$json = json_encode($data);

echo isset($_GET['callback']) ? "{$_GET['callback']}($json)" : $json;

?>
